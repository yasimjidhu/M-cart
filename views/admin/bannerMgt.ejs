<%- include('../user/partials/header') %>

<%- include('../user/partials/links') %>

<!--Navbar-->
<%- include('../admin/partials/nav') %>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-2 p-0">
            <%- include('../admin/partials/sidebar') %>
        </div>
        <div class="col-lg-10">
            <label for="bannerImageInput" class="custom-file-upload mt-4">
                <i class="fas fa-cloud-upload-alt" onclick="uploadImage()"></i> Add Banner
            </label>
            <input type="file" name="banner-image" id="bannerImageInput" style="display: none;" onchange="handleImageUpload()">

            <% if(allBanners && allBanners.length > 0){ %>
                <% allBanners.forEach(data =>{ %>
                    <div class="banner-management-container">
                        <div class="banner-item">
                            <img src="/uploads/banner-images/<%= data.image %>?timestamp=<%= new Date().getTime() %>" alt="Banner Preview" style="width: 100%; height: 40%;" />
                            <input type="file" id="changeBannerInput" name="banner-image" style="display: none;" onchange="changeBanner('<%=data._id %>')">
                            <button class="btn btn-danger mt-2 mb-2 float-right" onclick="confirmDelete('<%=data._id %>')">Delete Banner</button>
                            <button class="btn btn-success mt-2 mr-2 mb-2 float-right" onclick=uploadEditImage()>Change Banner</button>
                        </div>
                    </div>
                <% }) %>
            <% } %>                      
        </div>
    </div>
</div>

<script>
    function uploadImage() {
        const fileInput = document.getElementById('bannerImageInput');
        fileInput.click();
    }

    async function handleImageUpload() {
        const fileInput = document.getElementById('bannerImageInput');
        const file = fileInput.files[0];

        const formData = new FormData();
        formData.append('banner-image', file);

        try {
            const response = await fetch('/admin/upload-Banner', {
                method: 'POST',
                body: formData
            });
            
            if(response.invalidImage){
                Swal.fire({
                icon: 'error',
                title: 'Invalid Image',
                text: result.message || 'An error occurred while processing the image.',
                showConfirmButton:true
            });
            }
            const result = await response.json();
            window.location.reload()
            console.log(result);
        } catch (error) {
            console.error('Error uploading image:', error);
        }
    }

    function uploadEditImage(){
        const fileInput = document.getElementById('changeBannerInput')
        fileInput.click()
    }

    // CHANGE THE BANNER
    async function changeBanner(bannerId){
        const fileInput = document.getElementById('changeBannerInput')
        const file = fileInput.files[0]

        const formData = new FormData();
        formData.append('banner-image',file);

        try{
            const response = await fetch(`/admin/edit-banner/${bannerId}`,{
                method:'POST',
                body:formData
            });
            if(!response.ok){
                throw new Error()
            }
            const result = await response.json()
        }catch(err){
            console.error()
        }
    }

    // FUNCTION FOR ALERT
    function confirmDelete(bannerId) {
    Swal.fire({
        title: 'Are you sure?',
        text: 'Once deleted, you will not be able to recover this banner!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // User clicked "Yes, delete it!"
            deleteBanner(bannerId)
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Banner deleted successfully!',
                        showConfirmButton: true,
                    });
                    window.location.reload()
                })
                .catch(() => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed to delete banner.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }
    });
}



    // DELETE BANNER
    async function deleteBanner(bannerId){
        const response = await fetch(`/admin/delete-banner/${bannerId}`,{
            method:'DELETE',
            headers:{
                'Content-Type':'application/json'
            }  
        })

        if(!response.ok){
            throw new Error()
        }
        
    }





</script>
