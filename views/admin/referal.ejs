
<!--header-->

<%- include('../user/partials/header') %>
<%- include('../user/partials/links') %>
    <!--Navbar-->
<%-include('../admin/partials/nav') %>


<div class="container-fluid">
    <div class="row">
        <div class="col-lg-2 p-0">
            <%-include('../admin/partials/sidebar') %>
        </div>
        <div class="col-lg-10 p-0">
            <button type="button" class="btn btn-primary m-3" data-bs-toggle="modal" data-bs-target="#exampleModal">Add Referal offer</button>
              <!-- Modal -->
              <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
              aria-hidden="true">
              <div class="modal-dialog">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">Add Referal Offer</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form action="" id="addReferralOfferForm">
                  
                          <div class="form-group">
                            <label for="rewardAmount">Reward Amount</label>
                            <input type="number" min="0" class="form-control" id="rewardAmount" name="rewardAmount" placeholder="50">
                          </div>
                        
                          <div class="form-group">
                            <label for="validFrom">Valid From</label>
                            <input type="date" class="form-control" id="validFrom" name="validFrom">
                          </div>
                          <div class="form-group">
                            <label for="validUntil">Valid Until</label>
                            <input type="date" class="form-control" id="validUntil" name="validUntil">
                          </div>
                          <button type="submit" style="display: none;" id="hiddenSubmitBtn"></button>
                        </form>
                      </div>
                      
                      <div class="modal-footer">
                          <button type="button" class="btn btn-secondary"
                              data-bs-dismiss="modal">Close</button>
                          <button type="submit" class="btn btn-primary" id="AddReferalOfferSubmitBtn">Submit</button>
                      </div>
                  </div>
              </div>
          </div>
          <% if(allReferalData && allReferalData.length > 0 ){ %>
            <table class="mt-3 table table-striped">
                <thead>
                    <tr>
                        <th scope="col">Sl No</th>
                        <th scope="col">ReferalID</th>
                        <th scope="col">ReferedBy</th>
                        <th scope="col">New UserId</th>
                        <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody>
                        <% allReferalData.forEach((value,index) =>{ %>
                          <% value.referedUserInfo.forEach(item =>{ %>
                            <% value.invitedUserInfo.forEach(user =>{ %>
                            <tr>
                                <th scope="row"><%=index+1 %></th>
                                <td><%=value._id%></td>
                                <td><%=user.name%></td>
                                <td><%=item.name %></td>  
                                <td><button type="button" class="btn btn-danger px-2 py-1" onclick="confirmDeleteReferal('<%=value._id %>')">Delete</button></td>
                                <td><input id="productOfferID" type="hidden" value="<%=value._id %>"></td>
                            </tr>
                            <% }) %>                       
                            <% }) %>
                        <% }) %>
                    </tbody>
                </table>
                <% }else { %>
                    <div class="col-lg-12 m-0 p-0" style="display: flex;flex-direction: column;align-items: center;">
                        <img src="/images/theme/noData.jpg" alt="" width="55%">
                        <h3 class="text-danger">No product Offers are found</h3>
                    </div>
                <% } %>
        </div>
    </div>
</div>


  <!-- Add Bootstrap JS and Fetch polyfill for older browsers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.0.0/fetch.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
 
    

    // Submit form to create/update referral offers
    document.getElementById('AddReferalOfferSubmitBtn').addEventListener('click', async function(event) {
  event.preventDefault();

  document.getElementById('hiddenSubmitBtn').click();

  const formData = {
    offerAmount: document.getElementById('rewardAmount').value,
    validFrom: document.getElementById('validFrom').value,
    validUntil: document.getElementById('validUntil').value
  };

  try {
    const response = await fetch('/admin/add-referral-offers', {
      method: 'POST',
      body: JSON.stringify(formData),
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {

      const errorData = await response.json();
      Swal.fire({
        icon: 'error',
        title: 'Error occurred',
        text: errorData.message,
        showConfirmButton: false,
        timer: 3000
      });
      alert('Enter valid dates')

      throw new Error('Failed to add referral offer');
    }


    const data = await response.json();

    console.log('Referral offer added:', data);
    showAlert('success', 'Added', 'Referral offer added successfully');
    document.getElementById('referralOfferForm').reset();
  } catch (error) {
    console.error('Error creating/updating referral offer:', error);
    showAlert('error', 'Error occurred', 'Failed to add referral offer');
  }
});


    // Function to delete referral offers
    function confirmDeleteReferal(offerId) {
      if (confirm('Are you sure you want to delete this offer?')) {
        fetch(`/admin/delete-referral-offers/${offerId}`, {
            method: 'DELETE'
          })
          .then(() => {
           alert('deleted')
          })
          .catch(error => {
            console.error('Error deleting referral offer:', error);
          });
      }
    }


    function showAlert(icon, title, message) {
      Swal.fire({
        icon: icon,
        title: title,
        text: message,
        showConfirmButton: false,
        timer: 2000 // Set the duration for how long the alert will be shown (in milliseconds)
      });
    }


      
  </script>

